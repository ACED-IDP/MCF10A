class: sifter
name: transform

outdir: ../output

config:
  summaryTable: ../data/raw/summary_table.ndjson
  sampleAnnotations: ../data/raw/sample_annotations.ndjson
  hierarchy: ../data/raw/hierarchy.ndjson
  project_id: syn21577710
  schema: ../iceberg/schemas/

inputs:
  substanceData:
    plugin:
      commandLine: python3 substance_transform.py {{config.sampleAnnotations}} Substance ../data/fhir/Pre_Transform/Specimen.ndjson

  ObservationData:
    plugin:
      commandLine: python3 substance_transform.py {{config.sampleAnnotations}} Observation ../data/fhir/Pre_Transform/Specimen.ndjson

  researchStudyData:
    embedded:
      - #id: str(uuid.uuid5(ACED_NAMESPACE, PROJECT_ID)),
        title: 'LINCS MCF10A Molecular Deep Dive (MDD)'
        status: 'completed'
        identifier: [
            {
                'system': 'https://www.synapse.org/',
                'value': syn21577710
            }
        ]
  researchSubjectData:
    jsonLoad:
      input: "{{config.summaryTable}}"
  sampleAnnotationData:
    jsonLoad:
      input: "{{config.sampleAnnotations}}"
  hierarchyData:
    jsonLoad:
      input: "{{config.hierarchy}}"


pipelines:
  transform:
    - from: substanceData
    - project:
        mapping:
          resourceType: Substance

    - objectValidate:
        schema: "{{config.schema}}"
        title: Substance

    - emit:
        name: Substance

  
  transform_observation:
    - from: ObservationData
    - project:
        mapping:
          resourceType: Observation
    - objectValidate:
        schema: "{{config.schema}}"
        title: Observation
    - emit:
        name: Observation


  researchStudy:
    # Write out the node that represents the entire Research Study
    - from: researchStudyData
    - uuid:
        value: "{{config.project_id}}"
        field: id
        namespace: 'aced-ipd.org'
    - project:
        mapping:
          resourceType: ResearchStudy
    - objectValidate:
        schema: "{{config.schema}}"
        title: ResearchStudy
    - emit:
        name: ResearchStudy

  # Many fields here are extra for the FHIR model and cause FHIR validation errors for researchSubject downstream
  # This will need to be cleaned in the future, but for the purposes of the MCF10A data there is only one research subject
  # so it was just edited to FHIR compliance by hand

  researchSubject:
    - from: researchSubjectData
    - distinct:
        value: "{{row.Cell_Line}}"
    - uuid:
        value: "Patient/{{row.Cell_Line}}"
        field: patient_id
        namespace: 'aced-ipd.org'
    - uuid:
        value: "{{config.project_id}}"
        field: study_id
        namespace: 'aced-ipd.org'
    - uuid:
        value: "ResearchSubject/{{row.Cell_Line}}"
        field: subject_id
        # ^ vs. field: subject_idx from before
        namespace: 'aced-ipd.org'

    - project:
        mapping:
          id: "{{row.subject_id}}"
          resourceType: ResearchSubject
          subject: {"reference": "Patient/{{row.patient_id}}" }
          study: {"reference": "ResearchStudy/{{row.study_id}}"}
          status: 'on-study'
    # If object validation is off here, a bunch of extra fields will be generated.
        
    - objectValidate:
        schema: "{{config.schema}}"
        title: ResearchSubject
    - emit:
        name: ResearchSubject

  patient:
    - from: sampleAnnotationData
    - distinct:
        # in summary_table it's `Cell_Line` and in sample_annotations it's `cellLine`
        value: "{{row.cellLine}}"

    - uuid:
        value: "Patient/{{row.cellLine}}"
        field: patient_id
        namespace: 'aced-ipd.org'

    - map:
        method: fix
        gpython: | 
          def fix(row):
            row['id'] =  row["patient_id"]
            row[ 'identifier' ] = [
                {
                    'system': 'https://www.synapse.org/',
                    'value': row["cellLine"]
                }
            ]
            
            return row

    # This is not actually creating the resourceType field in the Patient json file     
    - project:
        mapping:
          resourceType: Patient
          
    - objectValidate:
        schema: "{{config.schema}}"
        title: Patient
    - emit: 
        name: Patient

  specimenDocs:
    - from: sampleAnnotationData
    - uuid:
        value: "Patient/{{row.cellLine}}"
        field: patient_id
        namespace: 'aced-ipd.org'
    - uuid:
        value: "Specimen/{{row.specimenName}}"
        field: id
        namespace: 'aced-ipd.org'

    - map: 
        method: fix
        #fix this later
        gpython: |
          def fix(row):
            out = {
              "id": row["id"],
              'subject': {'reference': "Patient/" + str(row["patient_id"])},
              'identifier': [
                {
                  'system': 'https://www.synapse.org/#specimenID',
                  'value': row['specimenID']
                },
                {
                  'system': 'https://www.synapse.org/#specimenName',
                  'value': row['specimenName']
                }
              ],
              'collection': {
                'bodySite': {
                  'concept':{
                    'coding': [{
                        'system': "http://purl.bioontology.org/ontology/SNOMEDCT",
                        'code': "76752008",
                        'display': "Breast Structure"
                      }],
                  'text':  row['cellType']
                  }
                }
              }
            }
            return out
    - project:
        mapping:
          resourceType: Specimen

    - emit:
        name: specimenDocs
  

  # Flatten hierarchy dile into list of contents of file names
  hierarchy:
    - from: hierarchyData
    - fieldProcess:
        field: file_names

  taskDocs:
    - from: sampleAnnotationData
    - uuid:
        value: "Patient/{{row.cellLine}}"
        field: patient_id
        namespace: 'aced-ipd.org'
    - uuid:
        value: "Specimen/{{row.specimenName}}"
        field: specimen_id
        namespace: 'aced-ipd.org'
    - flatmap:
        method: flatten
        gpython: | 
          def flatten(row):
            out = []
            mappings = {
              'ATACseq': ['https://ontobee.org/ontology/BAO',
                          '0010038',
                          'ATAC-seq Epigenetic Profiling Assay'],
              'Cyclic Immunoflourescence': ['https://ontobee.org/ontology/NCIT',
                          'C181929',
                          'Tissue-Based Cyclic Immunofluorescence'],
              'GCP': ['https://ontobee.org/ontology/BAO',
                          '0010039',
                          'Global Chromatin Epigenetic Profiling Assay'],
              'IF': ['https://ontobee.org/ontology/MMO',
                          '0000662',
                          'Immunofluorescence'],
              'L1000': ['https://ontobee.org/ontology/BAO',
                          '0010046',
                          'ATAC-seq Epigenetic Profiling Assay'],
              'live cell imaging': ['https://ontobee.org/ontology/CHEBI',
                          '39442',
                          'Fluorescent Probe Live Cell Imaging'],
              'RNAseq': ['https://ontobee.org/ontology/OBI',
                          '0001177',
                          'RNA sequencing assay'],
              'RPPA':  ['https://ontobee.org/ontology/NCIT',
                          'C184797',
                          'Reverse Phase Protein Array']
            }
            for k, v in row.items():
              if v.startswith("syn"):
                arr = mappings[k.split("_")[0]]
                out.append({
                  "assay_name": k,
                  "system":arr[0],
                  "code":arr[1],
                  "text":arr[2],
                  "synid": v,
                  "patient_id": row["patient_id"],
                  "specimen_id": row["specimen_id"],
                  "specimenName": row["specimenName"]
                })
            return out
    - uuid:
        value: "Task/{{row.specimenName}}-{{row.assay_name}}"
        field: task_id
        namespace: 'aced-ipd.org'

    - lookup:
        pipeline:
          from: hierarchy
          key: id_
        lookup: "{{row.synid}}"
        copy:
          entity: entity
          id_: id_
          _dirpath: _dirpath
    
    - filter:
        field: entity
        check: exists

  task:
    - from: taskDocs

    - uuid:
        value: "DocumentReference/{{row.specimen_id}}--{{row.enity.file_handle.etag}}"
        field: document_reference_id
        namespace: 'aced-idp.org'

    - map:
        method: fix
        gpython: |
          def fix(row):
            synapse_id = row["synid"]
            docRef = []
            if 'entity' in row:
              file_handle = row['entity']['file_handle']
              dID = row["document_reference_id"]
              docRef.append({
                'type': {
                  'coding': [{'system': 'http://hl7.org/fhir','code': 'DocumentReference'}],
                  'text': 'DocumentReference'
                },
                'valueReference': {'reference': "DocumentReference/" + dID}
              })

            return {
              'identifier':[{'value': synapse_id, 'system':'https://www.synapse.org/'}],
              'id': row["task_id"],
              'for': {'reference': "Patient/" + row["patient_id"]},
              'focus': {'reference': "Specimen/" + row["specimen_id"]},
              'status': 'completed',
              'intent': 'order',
              'code': {
                'coding': [{
                    'system': row["system"], 
                    'code': row["code"]
                  }],
                  'text': row["text"]
              },
              'input': [
                  {
                      'type': {
                          'coding': [{
                              'system': 'http://hl7.org/fhir',
                              'code': 'Specimen',
                              'display': 'Specimen'
                          }],
                          'text': 'Specimen'
                      },
                      'valueReference': {'reference': "Specimen/" + row["specimen_id"]}
                  }
              ],
              'output' : docRef
            }

    - project:
        mapping:
          resourceType: Task

    - objectValidate:
        schema: "{{config.schema}}"
        title: Task

    - emit:
        name: Task


  documentReference:
    - from: taskDocs

    - uuid:
        value: "DocumentReference/{{row.specimen_id}}--{{row.enity.file_handle.etag}}"
        field: id
        namespace: 'aced-idp.org'

    - map:
        method: fix
        gpython: |
          def fix(row):
            synapse_id = row["synid"]
            directory_name = "https://www.synapse.org/#!Synapse:"
            file_handle = row['entity']['file_handle']
            d = {
              'status': 'current',
              'subject':  {'reference': "Patient/" + str(row["patient_id"])},
              'id' : row['id'],
              'date': file_handle['createdOn'],
              'identifier': [
                  {
                      'system': 'https://www.synapse.org/',
                      'value': synapse_id
                  }
              ],
              'content': [
                  {
                      'attachment': {
                          'contentType': str(file_handle['contentType']),
                          'title': str(file_handle['fileName']),
                          'url': str(directory_name) + str(synapse_id),
                          'extension': [
                              {
                                  "url": "http://aced-idp.org/fhir/StructureDefinition/md5",
                                  "valueString": str(file_handle['contentMd5'])
                              }
                          ],
                          'size': int(file_handle['contentSize']),
                          'creation': str(file_handle['createdOn'])
                      }
                  }
              ]
            }
            return d


    - filter:
        field: content
        check: exists

    - distinct:
        value: "{{row.id}}"

    - project:
        mapping:
          resourceType: DocumentReference

    - objectValidate:
        schema: "{{config.schema}}"
        title: DocumentReference

    - emit:
        name: DocumentReference
